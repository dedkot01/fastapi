# Query-параметры и валидация строк

**FastAPI** позволяет определять дополнительную информацию и валидацию для ваших параметров.

Давайте рассмотрим следующий пример:

=== "Python 3.6 и выше"

    ```Python hl_lines="9"
    {!> ../../../docs_src/query_params_str_validations/tutorial001.py!}
    ```

=== "Python 3.10 и выше"

    ```Python hl_lines="7"
    {!> ../../../docs_src/query_params_str_validations/tutorial001_py310.py!}
    ```

Query-параметр `q` имеет тип `Union[str, None]` (или `str | None` в Python 3.10). Это означает, что входной параметр будет типа `str`, но может быть и `None`. Ещё параметр имеет значение по умолчанию `None`, из-за чего FastAPI определит параметр как необязательный.

!!! note "Технические детали"
    FastAPI определит параметр `q` как необязательный, потому что его значение по умолчанию `= None`.

    `Union` в `Union[str, None]` позволит редактору кода оказать вам лучшую поддержку и найти ошибки.

## Расширенная валидация

Добавим дополнительное условие валидации параметра `q` - **длина строки не более 50 символов** (условие проверяется всякий раз, когда параметр `q` не является `None`).

### Import `Query`

Чтобы достичь этого, первым делом нам нужно импортировать `Query` из пакета `fastapi`:

=== "Python 3.6 и выше"

    ```Python hl_lines="3"
    {!> ../../../docs_src/query_params_str_validations/tutorial002.py!}
    ```

=== "Python 3.10 и выше"

    ```Python hl_lines="1"
    {!> ../../../docs_src/query_params_str_validations/tutorial002_py310.py!}
    ```

## `Query` как значение по умолчанию

Теперь мы можем указать дополнительные условия валидации для параметра `q`. Определим у `Query` параметр `max_length` равным 50:

=== "Python 3.6 и выше"

    ```Python hl_lines="9"
    {!> ../../../docs_src/query_params_str_validations/tutorial002.py!}
    ```

=== "Python 3.10 и выше"

    ```Python hl_lines="7"
    {!> ../../../docs_src/query_params_str_validations/tutorial002_py310.py!}
    ```

Мы заменили значение по умолчанию с `None` на `Query()`. Теперь можно указать значение по умолчанию `Query(default=None)`. Это работает так же, как и задавалось ранее.

Таким образом:

```Python
q: Union[str, None] = Query(default=None)
```

...делает параметр необязательным, также как и:

```Python
q: Union[str, None] = None
```

И в Python 3.10 и выше:

```Python
q: str | None = Query(default=None)
```

...делает параметр необязательным, также как и:

```Python
q: str | None = None
```

Но он явно объявляет его как query-параметр.

!!! info "Дополнительная информация"
    Запомните, важной частью объявления параметра как необязательного является:

    ```Python
    = None
    ```

    или:

    ```Python
    = Query(default=None)
    ```

    так как `None` указан в качестве значения по умолчанию, параметр будет **необязательным**.

    `Union[str, None]` позволит редактору кода оказать вам лучшую поддержку. Но это не то, на что обращает внимание FastAPI для определения необязательности параметра.

Теперь, мы можем указать больше параметров для `Query`. В данном случае, параметр `max_length` применяется к строкам:

```Python
q: Union[str, None] = Query(default=None, max_length=50)
```

Входные данные будут проверены. Если данные недействительны, тогда будет указано на ошибку в запросе (будет описание местонахождения ошибки и её причины). Кроме того, параметр задокументируется в схеме OpenAPI данной *операции пути*.

## Больше валидации

Вы также можете добавить параметр `min_length`:

=== "Python 3.6 и выше"

    ```Python hl_lines="10"
    {!> ../../../docs_src/query_params_str_validations/tutorial003.py!}
    ```

=== "Python 3.10 и выше"

    ```Python hl_lines="7"
    {!> ../../../docs_src/query_params_str_validations/tutorial003_py310.py!}
    ```

## Регулярные выражения

Вы можете определить <abbr title="Регулярное выражение, regex или regexp - это последовательность символов, определяющая шаблон для строк.">регулярное выражение</abbr>, которому должен соответствовать параметр:

=== "Python 3.6 и выше"

    ```Python hl_lines="11"
    {!> ../../../docs_src/query_params_str_validations/tutorial004.py!}
    ```

=== "Python 3.10 и выше"

    ```Python hl_lines="9"
    {!> ../../../docs_src/query_params_str_validations/tutorial004_py310.py!}
    ```

Данное регулярное выражение проверяет, что полученное значение параметра:

* `^`: начало строки.
* `fixedquery`: в точности содержит строку `fixedquery`.
* `$`: конец строки, не имеет символов после `fixedquery`.

Не переживайте, если **"регулярное выражение"** вызывает у вас трудности. Это достаточно сложная тема для многих людей. Вы можете сделать множество вещей без использования регулярных выражений.

Но когда они вам понадобятся и освоите их, то вы уже знаете, что можете их использовать в **FastAPI**.

## Значения по умолчанию

Вы точно также можете указать любое значение `по умолчанию`, как ранее указывали `None`.

Например, вы хотите для параметра запроса `q` указать, что он должен состоять минимум из 3 символов (`min_length=3`) и иметь значение по умолчанию `"fixedquery"`:

```Python hl_lines="7"
{!../../../docs_src/query_params_str_validations/tutorial005.py!}
```

!!! note "Технические детали"
    Наличие значения по умолчанию делает параметр необязательным.

## Обязательный параметр

Когда вам не требуется дополнительная валидация или дополнительные метаданные для параметра запроса, вы можете сделать параметр `q` обязательным просто не указывая значения по умолчанию. Например:

```Python
q: str
```

вместо:

```Python
q: Union[str, None] = None
```

Но у нас query-параметр определён как `Query`. Например:

```Python
q: Union[str, None] = Query(default=None, min_length=3)
```

В таком случае, чтобы сделать query-параметр `Query` обязательным, вы можете просто не указывать значение по умолчанию:

```Python hl_lines="7"
{!../../../docs_src/query_params_str_validations/tutorial006.py!}
```

### Обязательный параметр с Ellipsis (`...`)

Альтернативный способ указать обязательность параметра запроса - это указать параметр `default` через многоточие `...`:

```Python hl_lines="7"
{!../../../docs_src/query_params_str_validations/tutorial006b.py!}
```

!!! info "Дополнительная информация"
    Если вы ранее не сталкивались с `...`: это специальное значение, <a href="https://docs.python.org/3/library/constants.html#Ellipsis" class="external-link" target="_blank">часть языка Python и называется "Ellipsis"</a>.

    Используется в Pydantic и FastAPI для определения, что значение требуется обязательно.

Таким образом, **FastAPI** определяет, что параметр является обязательным.

### Обязательный параметр с `None`

Вы можете определить, что параметр может принимать `None`, но всё ещё является обязательным. Это может потребоваться для того, чтобы пользователи явно указали параметр, даже если его значение будет `None`.

Чтобы этого добиться, вам нужно определить `None` как валидный тип для параметра запроса, но также указать `default=...`:

=== "Python 3.6 и выше"

    ```Python hl_lines="9"
    {!> ../../../docs_src/query_params_str_validations/tutorial006c.py!}
    ```

=== "Python 3.10 и выше"

    ```Python hl_lines="7"
    {!> ../../../docs_src/query_params_str_validations/tutorial006c_py310.py!}
    ```

!!! tip "Подсказка"
    Pydantic, мощь которого используется в FastAPI для валидации и сериализации, имеет специальное поведение для `Optional` или `Union[Something, None]` без значения по умолчанию. Вы можете узнать об этом больше в документации Pydantic, раздел <a href="https://pydantic-docs.helpmanual.io/usage/models/#required-optional-fields" class="external-link" target="_blank">Обязательные Опциональные поля</a>.

### Использование Pydantic's `Required` вместо Ellipsis (`...`)

Если вас смущает `...`, вы можете использовать `Required` из Pydantic:

```Python hl_lines="2  8"
{!../../../docs_src/query_params_str_validations/tutorial006d.py!}
```

!!! tip "Подсказка"
    Запомните, в каждом случае, когда вам необходимо объявить query-параметр обязательным, вы можете просто не указывать параметр `default`. Таким образом, вам редко придётся использовать `...` или `Required`.

## Множество значений для query-параметра

Для query-параметра `Query` можно указать, что он принимает список значений (множество значений).

Например, query-параметр `q` может быть указан в URL несколько раз. И если вы ожидаете такой формат запроса, то можете указать это следующим образом:

=== "Python 3.6 и выше"

    ```Python hl_lines="9"
    {!> ../../../docs_src/query_params_str_validations/tutorial011.py!}
    ```

=== "Python 3.9 и выше"

    ```Python hl_lines="9"
    {!> ../../../docs_src/query_params_str_validations/tutorial011_py39.py!}
    ```

=== "Python 3.10 и выше"

    ```Python hl_lines="7"
    {!> ../../../docs_src/query_params_str_validations/tutorial011_py310.py!}
    ```

Затем, получив такой URL:

```
http://localhost:8000/items/?q=foo&q=bar
```

вы бы получили несколько значений (`foo` и `bar`), которые относятся к параметру `q`, в виде Python `list` внутри вашей *функции обработки пути*, в *параметре функции* `q`.

Таким образом, ответ на этот URL будет:

```JSON
{
  "q": [
    "foo",
    "bar"
  ]
}
```

!!! tip "Подсказка"
    Чтобы объявить query-параметр типом `list`, как в примере выше, вам нужно явно использовать `Query`, иначе он будет интерпретирован как тело запроса.

Интерактивная документация API будет обновлена соответствующим образом, где будет разрешено множество значений:

<img src="/img/tutorial/query-params-str-validations/image02.png">

### Query-параметр со множеством значений по умолчанию

Вы также можете указать тип `list` со списком значений по умолчанию на случай, если вам их не предоставят:

=== "Python 3.6 и выше"

    ```Python hl_lines="9"
    {!> ../../../docs_src/query_params_str_validations/tutorial012.py!}
    ```

=== "Python 3.9 и выше"

    ```Python hl_lines="7"
    {!> ../../../docs_src/query_params_str_validations/tutorial012_py39.py!}
    ```

Если вы перейдёте по ссылке:

```
http://localhost:8000/items/
```

значение по умолчанию для `q` будет: `["foo", "bar"]` и ответом для вас будет:

```JSON
{
  "q": [
    "foo",
    "bar"
  ]
}
```

#### Использование `list`

Вы также можете использовать `list` напрямую вместо `List[str]` (или `list[str]` в Python 3.9+):

```Python hl_lines="7"
{!../../../docs_src/query_params_str_validations/tutorial013.py!}
```

!!! note "Технические детали"
    Запомните, что в таком случае, FastAPI не будет проверять содержимое списка.

    Например, для `List[int]` список будет провалидирован (и задокументирован) на содержимое, что все его элементы целочисленные. Но для простого `list` такой проверки не будет.

## Больше метаданных

Вы можете добавить больше информации об query-параметре.

Указанная информация будет включена в генерируемую OpenAPI документацию и использована в пользовательском интерфейсе и внешних инструментах.

!!! note "Технические детали"
    Имейте в виду, что разные инструменты могут иметь разные уровни поддержки OpenAPI.

    Некоторые из них могут еще не отображать всю заявленную дополнительную информацию, хотя в большинстве случаев отсутствующая функция уже запланирована к разработке.

Вы можете указать название query-параметра, используя параметр `title`:

=== "Python 3.6 и выше"

    ```Python hl_lines="10"
    {!> ../../../docs_src/query_params_str_validations/tutorial007.py!}
    ```

=== "Python 3.10 и выше"

    ```Python hl_lines="8"
    {!> ../../../docs_src/query_params_str_validations/tutorial007_py310.py!}
    ```

Добавить описание, используя параметр `description`:

=== "Python 3.6 и выше"

    ```Python hl_lines="13"
    {!> ../../../docs_src/query_params_str_validations/tutorial008.py!}
    ```

=== "Python 3.10 и выше"

    ```Python hl_lines="12"
    {!> ../../../docs_src/query_params_str_validations/tutorial008_py310.py!}
    ```

## Псевдонимы параметров

Представьте, что вы хотите использовать query-параметр с названием `item-query`.

Например:

```
http://127.0.0.1:8000/items/?item-query=foobaritems
```

Но `item-query` является невалидным именем переменной в Python.

Наиболее похожее валидное имя `item_query`.

Но вам всё равно необходим `item-query`...

Тогда вы можете объявить `псевдоним`, и этот псевдоним будет использоваться для поиска значения параметра запроса:

=== "Python 3.6 и выше"

    ```Python hl_lines="9"
    {!> ../../../docs_src/query_params_str_validations/tutorial009.py!}
    ```

=== "Python 3.10 и выше"

    ```Python hl_lines="7"
    {!> ../../../docs_src/query_params_str_validations/tutorial009_py310.py!}
    ```

## Устаревшие параметры

Предположим, вы больше не хотите использовать какой-либо параметр.

Вы решили оставить его, потому что клиенты всё ещё им пользуются. Но вы хотите отобразить это в документации как <abbr title="устарело, не рекомендуется использовать">устаревший функционал</abbr>.

Тогда для `Query` укажите параметр `deprecated=True`:

=== "Python 3.6 и выше"

    ```Python hl_lines="18"
    {!> ../../../docs_src/query_params_str_validations/tutorial010.py!}
    ```

=== "Python 3.10 и выше"

    ```Python hl_lines="17"
    {!> ../../../docs_src/query_params_str_validations/tutorial010_py310.py!}
    ```

В документации это будет отображено следующим образом:

<img src="/img/tutorial/query-params-str-validations/image01.png">

## Исключить из OpenAPI

Чтобы исключить query-параметр из генерируемой OpenAPI схемы (а также из системы автоматической генерации документации), укажите в `Query` параметр `include_in_schema=False`:

=== "Python 3.6 и выше"

    ```Python hl_lines="10"
    {!> ../../../docs_src/query_params_str_validations/tutorial014.py!}
    ```

=== "Python 3.10 и выше"

    ```Python hl_lines="8"
    {!> ../../../docs_src/query_params_str_validations/tutorial014_py310.py!}
    ```

## Резюме

Вы можете объявлять дополнительные правила валидации и метаданные для ваших параметров запроса.

Общие метаданные:

* `alias`
* `title`
* `description`
* `deprecated`

Специфичные правила валидации для строк:

* `min_length`
* `max_length`
* `regex`

В рассмотренных примерах показано объявление правил валидации для строковых значений `str`.

В следующих главах вы увидете, как объявлять правила валидации для других типов (например, чисел).
